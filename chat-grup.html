<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup Chat Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            height: 85vh;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* Login Scene */
        #loginScene {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 30px;
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
        }

        #loginScene h1 {
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #loginScene input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        #loginScene input:focus {
            outline: none;
            background: white;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        #loginScene button {
            width: 100%;
            padding: 15px;
            background-color: white;
            color: #4facfe;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #loginScene button:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #quickLoginButton {
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        #quickLoginButton:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #bannedMessage {
            display: none;
            background-color: rgba(255, 77, 79, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Chat Scene */
        #chatScene {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header .user-info {
            display: flex;
            flex-direction: column;
        }

        .chat-header .user-info .group-name {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .chat-header .user-info .online-count {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .chat-header .user-info .avatar {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 12px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .user-display {
            display: flex;
            align-items: center;
        }

        .admin-badge {
            color: #4facfe;
            margin-left: 5px;
            font-size: 14px;
        }

        .tools-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 20px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .tools-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tools-menu {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 10px;
            display: none;
            z-index: 100;
            min-width: 180px;
        }

        .tools-menu button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .tools-menu button:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #f5f7fa, #e4e8f0);
            background-attachment: fixed;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background-color: white;
            border-bottom-left-radius: 5px;
            color: #333;
        }

        .message .sender {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.9;
            display: flex;
            align-items: center;
        }

        .message .text {
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message .time {
            font-size: 11px;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }

        .message .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .message.sent:hover .delete-btn {
            display: flex;
        }

        .message.deleted {
            background-color: #f1f3f5;
            color: #868e96;
            font-style: italic;
        }

        /* File message styles */
        .file-message {
            margin-top: 5px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            max-width: 100%;
        }

        .file-message img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 12px;
            opacity: 0.7;
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: inherit;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s ease;
        }

        .download-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input.disabled {
            background-color: #f8f9fa;
            pointer-events: none;
            opacity: 0.7;
        }

        .chat-input.disabled input {
            background-color: #e9ecef;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #e9ecef;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .chat-input input:focus {
            outline: none;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .file-upload-button {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-right: 10px;
        }

        .file-upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .send-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .logout-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Upload Status */
        .upload-status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
        }

        .upload-status.uploading {
            background: #e3f2fd;
            color: #1976d2;
        }

        .upload-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .upload-status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            opacity: 0;
            animation: modalAppear 0.3s ease forwards;
        }

        @keyframes modalAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
            font-weight: 600;
        }

        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .modal input:focus, .modal select:focus, .modal textarea:focus {
            outline: none;
            background: white;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-buttons .cancel {
            background-color: #f8f9fa;
            color: #495057;
        }

        .modal-buttons .cancel:hover {
            background-color: #e9ecef;
        }

        .modal-buttons .confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-buttons .confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* System message */
        .system-message {
            text-align: center;
            font-style: italic;
            color: #6c757d;
            margin: 10px 0;
            font-size: 14px;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                height: 95vh;
                max-width: 100%;
                border-radius: 0;
            }
            
            body {
                padding: 0;
                background: white;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Scene -->
        <div id="loginScene">
            <h1>Grup Chat Online</h1>
            <input type="text" id="usernameInput" placeholder="Masukkan nama Anda">
            <button id="loginButton">Masuk ke Grup</button>
            <button id="quickLoginButton" style="display: none;">Login sebagai <span id="lastUsername"></span></button>
            <div id="bannedMessage">
                <p>üö´Akun Anda Telah Di Banned</p>
                <p> Karna Spam </p>
            </div>
        </div>

        <div id="chatScene">
            <div class="chat-header">
                <div class="user-info">
                    <div class="group-name">
                        <div class="user-display">
                            <div class="avatar" id="userAvatar"></div>
                            <span id="currentUsername"></span>
                            <span class="admin-badge" id="adminBadge" style="display: none;">‚úîÔ∏è</span>
                        </div>
                    </div>
                    <div class="online-count" id="onlineCount">0 Online</div>
                </div>
                <div class="header-buttons">
                    <button class="tools-button" id="toolsButton">Tools</button>
                    <button class="logout-button" id="logoutButton">Logout</button>
                </div>
            </div>

            <div class="tools-menu" id="toolsMenu">
                <button id="deleteOthersBtn">Hapus Pesan lain</button>
                <button id="banUserBtn">Ban User</button>
                <button id="warnUserBtn">Kirim Peringatan</button>
                <button id="makeAdminBtn">Jadikan Admin</button>
                <button id="toggleGroupBtn">Tutup Grup</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Pesan akan ditampilkan di sini -->
            </div>

            <div class="chat-input" id="chatInput">
                <input type="file" id="fileInput" style="display: none;" accept="*/*">
                <button class="file-upload-button" id="fileUploadButton">üìé</button>
                <input type="text" id="messageInput" placeholder="Ketik pesan...">
                <button class="send-button" id="sendButton">‚û§</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteMessageModal">
        <div class="modal-content">
            <h2>Hapus Pesan</h2>
            <p>Pilih pesan yang ingin dihapus:</p>
            <div id="messageList"></div>
            <div class="modal-buttons">
                <button class="cancel" id="cancelDelete">Batal</button>
                <button class="confirm" id="confirmDelete">Hapus</button>
            </div>
        </div>
    </div>

    <div class="modal" id="banUserModal">
        <div class="modal-content">
            <h2>Banned User</h2>
            <input type="text" id="userToBan" placeholder="Nama user yang akan dibanned">
            <input type="number" id="banDuration" placeholder="Durasi banned (menit)" value="60">
            <div class="modal-buttons">
                <button class="cancel" id="cancelBan">Batal</button>
                <button class="confirm" id="confirmBan">Banned</button>
            </div>
        </div>
    </div>

    <div class="modal" id="warnUserModal">
        <div class="modal-content">
            <h2>Berikan Peringatan</h2>
            <input type="text" id="userToWarn" placeholder="Nama user yang akan diperingatkan">
            <textarea id="warningMessage" placeholder="Pesan peringatan"></textarea>
            <div class="modal-buttons">
                <button class="cancel" id="cancelWarn">Batal</button>
                <button class="confirm" id="confirmWarn">Kirim Peringatan</button>
            </div>
        </div>
    </div>

    <div class="modal" id="makeAdminModal">
        <div class="modal-content">
            <h2>Jadikan Admin</h2>
            <input type="text" id="userToAdmin" placeholder=Masukan Username">
            <div class="modal-buttons">
                <button class="cancel" id="cancelAdmin">Batal</button>
                <button class="confirm" id="confirmAdmin">Jadikan Admin</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAlMyO9iybb7Zc3-JWpaJTOU6mp7dVZw7A",
            authDomain: "taher-online.firebaseapp.com",
            databaseURL: "https://taher-online-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taher-online",
            storageBucket: "taher-online.firebasestorage.app",
            messagingSenderId: "254196950669",
            appId: "1:254196950669:web:ea7dc25e29e459e791e4c4",
            measurementId: "G-W288VV18S2"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // DB
        const messagesRef = database.ref('messages');
        const usersRef = database.ref('users');
        const bannedUsersRef = database.ref('bannedUsers');
        const onlineUsersRef = database.ref('onlineUsers');
        const adminsRef = database.ref('admins');
        const groupStatusRef = database.ref('groupStatus');
        const userDevicesRef = database.ref('userDevices');

        // Variabel global
        let currentUser = null;
        let isTaherUser = false;
        let isAdmin = false;
        let bannedUsers = {};
        let onlineUsers = {};
        let admins = {};
        let groupClosed = false;

        // Kata terlarang
        const forbiddenWords = ['Tuti', 'Udin', 'Haer', 'Tut', 'Adam'];
        const forbiddenEmojis = ['‚úÖ', '‚úì', '‚úîÔ∏è', '‚òëÔ∏è'];

        // Event Listeners
        document.getElementById('loginButton').addEventListener('click', login);
        document.getElementById('logoutButton').addEventListener('click', logout);
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Tools func
        document.getElementById('toolsButton').addEventListener('click', toggleToolsMenu);
        document.getElementById('deleteOthersBtn').addEventListener('click', showDeleteMessageModal);
        document.getElementById('banUserBtn').addEventListener('click', showBanUserModal);
        document.getElementById('warnUserBtn').addEventListener('click', showWarnUserModal);
        document.getElementById('makeAdminBtn').addEventListener('click', showMakeAdminModal);
        document.getElementById('toggleGroupBtn').addEventListener('click', toggleGroupStatus);

        // File upload functionality
        document.getElementById('fileUploadButton').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // Quick login functionality
        document.getElementById('quickLoginButton').addEventListener('click', quickLogin);

        // Modal buttons
        document.getElementById('cancelDelete').addEventListener('click', () => document.getElementById('deleteMessageModal').style.display = 'none');
        document.getElementById('confirmDelete').addEventListener('click', deleteSelectedMessage);
        document.getElementById('cancelBan').addEventListener('click', () => document.getElementById('banUserModal').style.display = 'none');
        document.getElementById('confirmBan').addEventListener('click', banUser);
        document.getElementById('cancelWarn').addEventListener('click', () => document.getElementById('warnUserModal').style.display = 'none');
        document.getElementById('confirmWarn').addEventListener('click', warnUser);
        document.getElementById('cancelAdmin').addEventListener('click', () => document.getElementById('makeAdminModal').style.display = 'none');
        document.getElementById('confirmAdmin').addEventListener('click', makeAdmin);

        // Fungsi untuk toggle menu tools
        function toggleToolsMenu() {
            const toolsMenu = document.getElementById('toolsMenu');
            toolsMenu.style.display = toolsMenu.style.display === 'block' ? 'none' : 'block';
        }

        // Fungsi untuk mendapatkan informasi perangkat dan IP
        async function getDeviceAndIPInfo() {
            try {
                // Dapatkan IP address menggunakan service eksternal
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ipAddress = ipData.ip;
                
                // Informasi perangkat
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    vendor: navigator.vendor,
                    screenResolution: `${screen.width}x${screen.height}`,
                    colorDepth: screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookiesEnabled: navigator.cookieEnabled,
                    javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
                    pdfEnabled: navigator.pdfViewerEnabled || false
                };
                
                // Deteksi perangkat mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                deviceInfo.isMobile = isMobile;
                
                // Deteksi browser
                let browser = 'Unknown';
                if (navigator.userAgent.indexOf("Chrome") !== -1) browser = "Chrome";
                else if (navigator.userAgent.indexOf("Firefox") !== -1) browser = "Firefox";
                else if (navigator.userAgent.indexOf("Safari") !== -1) browser = "Safari";
                else if (navigator.userAgent.indexOf("Edge") !== -1) browser = "Edge";
                else if (navigator.userAgent.indexOf("Opera") !== -1) browser = "Opera";
                deviceInfo.browser = browser;
                
                return {
                    ipAddress: ipAddress,
                    deviceInfo: deviceInfo,
                    timestamp: Date.now()
                };
            } catch (error) {
                console.error('Error getting device and IP info:', error);
                return {
                    ipAddress: 'Unknown',
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                    },
                    timestamp: Date.now()
                };
            }
        }

        // Fungsi login
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!username) {
                alert('Masukkan nama terlebih dahulu!');
                return;
            }

            // Cek apakah user dibanned
            checkIfBanned(username).then(async isBanned => {
                if (isBanned) {
                    document.getElementById('bannedMessage').style.display = 'block';
                    return;
                }

                currentUser = username;
                isTaherUser = username.toLowerCase().includes('taher');
                
                // Dapatkan informasi perangkat dan IP
                const deviceData = await getDeviceAndIPInfo();
                
                // Cek apakah user adalah admin
                checkIfAdmin(username).then(adminStatus => {
                    isAdmin = adminStatus || isTaherUser;
                    
                    // Simpan data user
                    const userData = {
                        name: username,
                        loginTime: Date.now(),
                        deviceInfo: deviceData.deviceInfo,
                        ipAddress: deviceData.ipAddress
                    };
                    
                    usersRef.child(username).set(userData);
                    
                    // Simpan informasi perangkat secara terpisah untuk tracking
                    const deviceKey = `${username}_${Date.now()}`;
                    userDevicesRef.child(deviceKey).set({
                        username: username,
                        ...deviceData
                    });
                    
                    // Set user online
                    setUserOnline(username);
                    
                    // Simpan data login di localStorage
                    localStorage.setItem('lastUsername', username);
                    
                    // Tampilkan scene chat
                    document.getElementById('loginScene').style.display = 'none';
                    document.getElementById('chatScene').style.display = 'flex';
                    document.getElementById('currentUsername').textContent = username;
                    document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                    
                    // Tampilkan badge admin jika admin
                    if (isAdmin) {
                        document.getElementById('adminBadge').style.display = 'inline';
                    }
                    
                    // Tampilkan atau sembunyikan tombol tools berdasarkan user
                    if (isAdmin) {
                        document.getElementById('toolsButton').style.display = 'block';
                    } else {
                        document.getElementById('toolsButton').style.display = 'none';
                    }
                    
                    // Load pesan
                    loadMessages();
                });
            });
        }

        // Fungsi untuk set user online
        function setUserOnline(username) {
            onlineUsersRef.child(username).set({
                name: username,
                lastSeen: Date.now(),
                isOnline: true
            });
            
            // Update status online setiap 30 detik
            setInterval(() => {
                if (currentUser === username) {
                    onlineUsersRef.child(username).update({
                        lastSeen: Date.now()
                    });
                }
            }, 30000);
        }

        // Fungsi untuk update jumlah user online
        function updateOnlineCount() {
            onlineUsersRef.on('value', snapshot => {
                const users = snapshot.val();
                let count = 0;
                const now = Date.now();
                
                if (users) {
                    Object.values(users).forEach(user => {
                        // User dianggap online jika terakhir terlihat dalam 1 menit terakhir
                        if (user.lastSeen && (now - user.lastSeen) < 60000) {
                            count++;
                        }
                    });
                }
                
                document.getElementById('onlineCount').textContent = count + ' Online';
            });
        }

        // Fungsi untuk cek apakah user adalah admin
        function checkIfAdmin(username) {
            return adminsRef.child(username).once('value').then(snapshot => {
                return snapshot.exists();
            });
        }

        // Fungsi login cepat
        function quickLogin() {
            const lastUsername = localStorage.getItem('lastUsername');
            if (lastUsername) {
                document.getElementById('usernameInput').value = lastUsername;
                login();
            }
        }

        // Fungsi logout - DIPERBAIKI: Refresh halaman setelah logout
        function logout() {
            // Set user offline
            if (currentUser) {
                onlineUsersRef.child(currentUser).remove();
            }
            
            // Refresh halaman untuk membersihkan state
            location.reload();
        }

        // Fungsi kirim pesan
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            // Cek kata terlarang
            if (containsForbiddenWords(messageText) && !isAdmin) {
                // User melanggar aturan, banned
                banUserAutomatically(currentUser);
                return;
            }
            
            // Cek emoji terlarang untuk user biasa
            if (!isAdmin && containsForbiddenEmojis(messageText)) {
                alert('Anda tidak diizinkan menggunakan emoji centang!');
                return;
            }
            
            // Simpan pesan ke Firebase
            const messageData = {
                text: messageText,
                sender: currentUser,
                timestamp: Date.now(),
                id: generateMessageId(),
                type: 'text',
                isAdmin: isAdmin
            };
            
            messagesRef.push(messageData);
            
            // Kosongkan input
            messageInput.value = '';
        }

        // Fungsi untuk menangani upload file (local storage)
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('Memulai upload file:', file.name, 'tipe:', file.type, 'ukuran:', file.size);

            // Validasi ukuran file (maksimal 5MB untuk local storage)
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file terlalu besar. Maksimal 5MB. Ukuran file: ' + (file.size/1024/1024).toFixed(2) + ' MB');
                return;
            }

            // Tampilkan status upload
            showUploadStatus('Mengunggah file ' + file.name + '...', 'uploading');
            
            // Baca file sebagai data URL (base64)
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Simpan file di localStorage dengan key unik
                const fileKey = 'chat_file_' + Date.now() + '_' + file.name;
                localStorage.setItem(fileKey, e.target.result);
                
                // Simpan pesan file ke Firebase
                const messageData = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    sender: currentUser,
                    timestamp: Date.now(),
                    id: generateMessageId(),
                    type: 'file',
                    fileKey: fileKey,
                    isAdmin: isAdmin
                };
                
                messagesRef.push(messageData);
                
                // Reset input file
                document.getElementById('fileInput').value = '';
                
                // Tampilkan status sukses
                showUploadStatus('File ' + file.name + ' berhasil diunggah!', 'success');
                
                // Hapus status setelah 3 detik
                setTimeout(() => {
                    hideUploadStatus();
                }, 3000);
            };
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                showUploadStatus('Gagal membaca file', 'error');
                
                // Hapus status setelah 5 detik
                setTimeout(() => {
                    hideUploadStatus();
                }, 5000);
            };
            
            reader.readAsDataURL(file);
        }

        // Fungsi untuk menampilkan status upload
        function showUploadStatus(message, type) {
            // Hapus status sebelumnya jika ada
            hideUploadStatus();
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `upload-status ${type}`;
            statusDiv.id = 'uploadStatus';
            statusDiv.textContent = message;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(statusDiv);
            
            // Scroll ke bawah untuk melihat status
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Fungsi untuk menyembunyikan status upload
        function hideUploadStatus() {
            const existingStatus = document.getElementById('uploadStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
        }

        // Fungsi load pesan
        function loadMessages() {
            messagesRef.on('value', snapshot => {
                const messages = snapshot.val();
                const chatMessages = document.getElementById('chatMessages');
                
                // Simpan posisi scroll sebelum memperbarui pesan
                const wasScrolledToBottom = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 1;
                
                // Hapus semua pesan kecuali status upload
                const uploadStatus = document.getElementById('uploadStatus');
                chatMessages.innerHTML = '';
                if (uploadStatus) {
                    chatMessages.appendChild(uploadStatus);
                }
                
                if (!messages) return;
                
                // Urutkan pesan berdasarkan timestamp
                const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                
                sortedMessages.forEach(message => {
                    if (!message.deleted || (message.deleted && message.sender === currentUser)) {
                        displayMessage(message);
                    }
                });
                
                // Scroll ke bawah jika sebelumnya sudah di paling bawah
                if (wasScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Fungsi tampilkan pesan
        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${message.sender === currentUser ? 'sent' : 'received'}`;
            if (message.deleted) {
                messageDiv.classList.add('deleted');
            }
            
            messageDiv.dataset.id = message.id;
            
            let messageContent = '';
            
            if (message.deleted) {
                messageContent = `
                    <div class="text">Pesan telah dihapus</div>
                    <div class="time">${formatTime(message.timestamp)}</div>
                `;
            } else {
                // Tambahkan badge admin jika pengirim adalah admin
                const adminBadge = message.isAdmin ? '<span class="admin-badge">‚úÖ</span>' : '';
                
                if (message.type === 'file') {
                    // Tampilkan pesan file
                    const fileSize = formatFileSize(message.fileSize);
                    let fileIcon = 'üìÑ';
                    
                    // Tentukan ikon berdasarkan tipe file
                    if (message.fileType.startsWith('image/')) {
                        fileIcon = 'üñºÔ∏è';
                    } else if (message.fileType.startsWith('audio/')) {
                        fileIcon = 'üéµ';
                    } else if (message.fileType.startsWith('video/')) {
                        fileIcon = 'üé•';
                    } else if (message.fileType.includes('pdf')) {
                        fileIcon = 'üìï';
                    } else if (message.fileType.includes('word') || message.fileType.includes('document')) {
                        fileIcon = 'üìù';
                    }
                    
                    // Ambil file dari localStorage
                    const fileData = localStorage.getItem(message.fileKey);
                    
                    messageContent = `
                        <div class="sender">${message.sender} ${adminBadge}</div>
                        <div class="file-message">
                            <div class="file-icon">${fileIcon}</div>
                            <div class="file-info">
                                <div class="file-name">${message.fileName}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                            ${fileData ? `<a href="${fileData}" download="${message.fileName}" class="download-btn">Unduh</a>` : '<span class="download-btn">File tidak tersedia</span>'}
                        </div>
                    `;
                    
                    // Jika file adalah gambar dan tersedia, tampilkan preview
                    if (fileData && message.fileType.startsWith('image/')) {
                        messageContent += `<img src="${fileData}" alt="${message.fileName}" style="max-width: 100%; border-radius: 8px; margin-top: 5px;" loading="lazy">`;
                    }
                    
                    messageContent += `<div class="time">${formatTime(message.timestamp)}</div>`;
                } else {
                    // Tampilkan pesan teks biasa
                    messageContent = `
                        <div class="sender">${message.sender} ${adminBadge}</div>
                        <div class="text">${message.text}</div>
                        <div class="time">${formatTime(message.timestamp)}</div>
                    `;
                }
                
                // Tambahkan tombol hapus untuk pesan yang dikirim oleh user saat ini
                if (message.sender === currentUser) {
                    messageContent += `<button class="delete-btn" onclick="deleteMessage('${message.id}')">‚úï</button>`;
                }
            }
            
            messageDiv.innerHTML = messageContent;
            chatMessages.appendChild(messageDiv);
        }

        // Fungsi hapus pesan sendiri - DIPERBAIKI: Hapus langsung dari database
        function deleteMessage(messageId) {
            // Cari pesan dengan ID tersebut
            messagesRef.once('value', snapshot => {
                const messages = snapshot.val();
                
                Object.keys(messages).forEach(key => {
                    if (messages[key].id === messageId && messages[key].sender === currentUser) {
                        // Hapus langsung dari database
                        messagesRef.child(key).remove()
                            .then(() => {
                                console.log('Pesan berhasil dihapus dari database');
                            })
                            .catch(error => {
                                console.error('Error menghapus pesan:', error);
                            });
                    }
                });
            });
        }

        // Fungsi cek kata terlarang
        function containsForbiddenWords(text) {
            const lowerText = text.toLowerCase();
            return forbiddenWords.some(word => lowerText.includes(word.toLowerCase()));
        }

        // Fungsi cek emoji terlarang
        function containsForbiddenEmojis(text) {
            return forbiddenEmojis.some(emoji => text.includes(emoji));
        }

        // Fungsi banned otomatis
        function banUserAutomatically(username) {
            const banData = {
                username: username,
                bannedBy: 'System',
                reason: 'Menggunakan kata terlarang',
                timestamp: Date.now(),
                unbannedAt: Date.now() + (60 * 60 * 1000) // 1 jam
            };
            
            bannedUsersRef.child(username).set(banData);
            
            // Tampilkan pesan banned dan logout
            document.getElementById('bannedMessage').style.display = 'block';
            logout();
        }

        // Fungsi cek apakah user dibanned
        function checkIfBanned(username) {
            return bannedUsersRef.child(username).once('value').then(snapshot => {
                const banData = snapshot.val();
                
                if (!banData) return false;
                
                // Cek apakah banned sudah berakhir
                if (banData.unbannedAt && Date.now() > banData.unbannedAt) {
                    // Hapus dari banned
                    bannedUsersRef.child(username).remove();
                    return false;
                }
                
                return true;
            });
        }

        // Fungsi untuk modal hapus pesan orang lain
        function showDeleteMessageModal() {
            const modal = document.getElementById('deleteMessageModal');
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            
            // Ambil semua pesan
            messagesRef.once('value', snapshot => {
                const messages = snapshot.val();
                
                if (!messages) return;
                
                Object.values(messages).forEach(message => {
                    if (!message.deleted && message.sender !== currentUser) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message-item';
                        messageDiv.innerHTML = `
                            <input type="radio" name="selectedMessage" value="${message.id}">
                            <span><strong>${message.sender}:</strong> ${message.type === 'file' ? 'üìé ' + message.fileName : message.text}</span>
                        `;
                        messageList.appendChild(messageDiv);
                    }
                });
            });
            
            modal.style.display = 'flex';
        }

        // Fungsi hapus pesan yang dipilih - DIPERBAIKI: Hapus langsung dari database
        function deleteSelectedMessage() {
            const selectedMessage = document.querySelector('input[name="selectedMessage"]:checked');
            
            if (!selectedMessage) {
                alert('Pilih pesan yang akan dihapus!');
                return;
            }
            
            const messageId = selectedMessage.value;
            
            // Cari dan hapus pesan
            messagesRef.once('value', snapshot => {
                const messages = snapshot.val();
                
                Object.keys(messages).forEach(key => {
                    if (messages[key].id === messageId) {
                        // Hapus langsung dari database
                        messagesRef.child(key).remove()
                            .then(() => {
                                console.log('Pesan berhasil dihapus dari database');
                            })
                            .catch(error => {
                                console.error('Error menghapus pesan:', error);
                            });
                    }
                });
            });
            
            document.getElementById('deleteMessageModal').style.display = 'none';
        }

        // Fungsi untuk modal banned user
        function showBanUserModal() {
            document.getElementById('banUserModal').style.display = 'flex';
        }

        // Fungsi banned user
        function banUser() {
            const username = document.getElementById('userToBan').value.trim();
            const duration = parseInt(document.getElementById('banDuration').value) || 60;
            
            if (!username) {
                alert('Masukkan nama user!');
                return;
            }
            
            const banData = {
                username: username,
                bannedBy: currentUser,
                reason: 'Tanpa alasan',
                timestamp: Date.now(),
                unbannedAt: Date.now() + (duration * 60 * 1000) // Durasi dalam menit
            };
            
            bannedUsersRef.child(username).set(banData);
            
            // Kirim pesan sistem
            const systemMessage = {
                text: `User ${username} telah dibanned oleh ${currentUser} selama ${duration} menit.`,
                sender: 'System',
                timestamp: Date.now(),
                id: generateMessageId(),
                type: 'text'
            };
            
            messagesRef.push(systemMessage);
            
            document.getElementById('banUserModal').style.display = 'none';
            document.getElementById('userToBan').value = '';
            document.getElementById('banDuration').value = '60';
        }

        // Fungsi untuk modal peringatan user
        function showWarnUserModal() {
            document.getElementById('warnUserModal').style.display = 'flex';
        }

        // Fungsi berikan peringatan
        function warnUser() {
            const username = document.getElementById('userToWarn').value.trim();
            const warning = document.getElementById('warningMessage').value.trim();
            
            if (!username || !warning) {
                alert('Isi semua field!');
                return;
            }
            
            // Kirim pesan peringatan
            const warningMessage = {
                text: `PERINGATAN untuk ${username}: ${warning}`,
                sender: 'System',
                timestamp: Date.now(),
                id: generateMessageId(),
                type: 'text'
            };
            
            messagesRef.push(warningMessage);
            
            document.getElementById('warnUserModal').style.display = 'none';
            document.getElementById('userToWarn').value = '';
            document.getElementById('warningMessage').value = '';
        }

        // Fungsi untuk modal jadikan admin
        function showMakeAdminModal() {
            document.getElementById('makeAdminModal').style.display = 'flex';
        }

        // Fungsi jadikan admin
        function makeAdmin() {
            const username = document.getElementById('userToAdmin').value.trim();
            
            if (!username) {
                alert('Masukkan nama user!');
                return;
            }
            
            // Jadikan user sebagai admin
            adminsRef.child(username).set(true);
            
            // Kirim pesan sistem
            const systemMessage = {
                text: `User ${username} sekarang menjadi admin.`,
                sender: 'System',
                timestamp: Date.now(),
                id: generateMessageId(),
                type: 'text'
            };
            
            messagesRef.push(systemMessage);
            
            document.getElementById('makeAdminModal').style.display = 'none';
            document.getElementById('userToAdmin').value = '';
        }

        // Fungsi untuk toggle status grup (buka/tutup)
        function toggleGroupStatus() {
            const newStatus = !groupClosed;
            groupStatusRef.set(newStatus ? 'closed' : 'open');
            
            // Kirim pesan sistem
            const systemMessage = {
                text: `Grup telah ${newStatus ? 'ditutup' : 'dibuka'} oleh ${currentUser}. ${newStatus ? 'GRUP TELAH DI TUTUP‚ùó.' : ''}`,
                sender: 'System',
                timestamp: Date.now(),
                id: generateMessageId(),
                type: 'text'
            };
            
            messagesRef.push(systemMessage);
            
            // Update tombol tools
            document.getElementById('toggleGroupBtn').textContent = newStatus ? 'Buka Grup' : 'Tutup Grup';
        }

        // Fungsi untuk update status grup
        function updateGroupStatus() {
            groupStatusRef.on('value', snapshot => {
                groupClosed = snapshot.val() === 'closed';
                
                // Update UI berdasarkan status grup
                const chatInput = document.getElementById('chatInput');
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                const fileUploadButton = document.getElementById('fileUploadButton');
                
                if (groupClosed && !isAdmin) {
                    chatInput.classList.add('disabled');
                    messageInput.placeholder = 'Grup ditutup. Hanya admin yang bisa mengirim pesan.';
                    sendButton.disabled = true;
                    fileUploadButton.disabled = true;
                } else {
                    chatInput.classList.remove('disabled');
                    messageInput.placeholder = 'Ketik pesan...';
                    sendButton.disabled = false;
                    fileUploadButton.disabled = false;
                }
                
                // Update tombol tools
                document.getElementById('toggleGroupBtn').textContent = groupClosed ? 'Buka Grup' : 'Tutup Grup';
            });
        }

        // Fungsi utilitas
        function generateMessageId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', () => {
            // Load daftar banned users
            bannedUsersRef.on('value', snapshot => {
                bannedUsers = snapshot.val() || {};
            });

            // Setup online users tracking
            updateOnlineCount();

            // Setup group status tracking
            updateGroupStatus();

            // Cek apakah ada data login sebelumnya
            const lastUsername = localStorage.getItem('lastUsername');
            if (lastUsername) {
                document.getElementById('quickLoginButton').style.display = 'block';
                document.getElementById('lastUsername').textContent = lastUsername;
            }

            // Setup beforeunload event untuk menandai user offline saat keluar
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    onlineUsersRef.child(currentUser).remove();
                }
            });
        });
    </script>
</body>
</html>